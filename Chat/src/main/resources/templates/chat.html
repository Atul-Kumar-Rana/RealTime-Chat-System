<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>RealTime Chat — Sexy UI</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root{
          --accent:#6c5ce7;
          --muted:#9aa0a6;
          --bg:#0f1724;
          --card:#0b1220;
          --me-bg:#cfe9ff;
          --other-bg:#111827;
        }
        html,body{height:100%;}
        body{
          font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
          background: linear-gradient(135deg,#071021 0%, #061428 100%);
          color:#e6eef6;
          margin:0;
          padding:24px;
        }

        .app {
          max-width: 980px;
          margin: 0 auto;
          display:flex;
          flex-direction:column;
          gap:16px;
        }

        .topbar {
          display:flex;
          align-items:center;
          justify-content:space-between;
          gap:12px;
        }

        .brand {
          display:flex;
          gap:12px;
          align-items:center;
        }

        .logo {
          width:48px;
          height:48px;
          border-radius:10px;
          background:linear-gradient(135deg,#6c5ce7,#00bcd4);
          display:flex;
          align-items:center;
          justify-content:center;
          color:#fff;
          font-weight:700;
          font-size:18px;
          box-shadow:0 6px 18px rgba(108,92,231,0.25);
        }

        .title {
          font-weight:700;
          font-size:18px;
          letter-spacing:0.2px;
        }
        .subtitle { font-size:12px; color:var(--muted); }

        .userBox {
          display:flex;
          gap:12px;
          align-items:center;
        }

        .usernameBadge {
          background: rgba(255,255,255,0.06);
          padding:8px 12px;
          border-radius:999px;
          font-weight:600;
          font-size:14px;
          display:flex;
          gap:10px;
          align-items:center;
          color:#e6eef6;
        }

        .mainCard{
          background: rgba(255,255,255,0.03);
          border-radius:14px;
          padding:18px;
          display:flex;
          gap:16px;
          min-height:520px;
          box-shadow: 0 8px 30px rgba(2,6,23,0.6);
        }

        .chatWindow{
          flex:1;
          display:flex;
          flex-direction:column;
          gap:12px;
        }

        .messages {
          background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
          border-radius:12px;
          padding:16px;
          height:420px;
          overflow:auto;
          box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
        }

        .msg {
          display:flex;
          flex-direction:column;
          max-width:74%;
          margin-bottom:10px;
          word-wrap:break-word;
        }

        .meta {
          font-size:12px;
          color:var(--muted);
          margin-bottom:6px;
        }

        .bubble {
          padding:10px 14px;
          border-radius:12px;
          font-size:14px;
          line-height:1.35;
        }

        .me {
          align-self:flex-end;
          text-align:right;
        }

        .me .bubble {
          background: linear-gradient(90deg,#dbeffd,#cfe9ff);
          color:#042135;
          border-bottom-right-radius:4px;
          box-shadow: 0 6px 16px rgba(12,52,92,0.18);
        }

        .other {
          align-self:flex-start;
        }

        .other .bubble {
          background: rgba(255,255,255,0.03);
          color:#e6eef6;
          border-bottom-left-radius:4px;
          box-shadow: 0 4px 12px rgba(2,6,23,0.6);
        }

        .controls {
          display:flex;
          gap:12px;
          margin-top:8px;
          align-items:center;
        }

        .inputWrap{
          display:flex;
          gap:8px;
          align-items:center;
          width:100%;
        }

        .inputWrap input[type="text"]{
          border-radius:10px;
          border:0;
          padding:12px 14px;
          background: rgba(255,255,255,0.02);
          color:inherit;
          width:100%;
          outline:none;
        }

        .btn-primary {
          background: linear-gradient(90deg,var(--accent),#00bcd4);
          border:0;
          padding:10px 16px;
          border-radius:10px;
          font-weight:600;
          box-shadow:0 8px 22px rgba(108,92,231,0.18);
        }

        .small-muted { font-size:13px; color:var(--muted); }

        @media (max-width:720px){
          .mainCard{ padding:12px; min-height: 600px; }
          .messages{ height:380px; }
        }
    </style>
</head>
<body>
<div class="app container">
    <div class="topbar">
        <div class="brand">
            <div class="logo">RT</div>
            <div>
                <div class="title">RealTime Chat</div>
                <div class="subtitle">Talk-to-Stranger • Real-time • Lightweight</div>
            </div>
        </div>

        <div class="userBox">
            <div class="small-muted me-2">Signed in as</div>
            <div id="usernameDisplay" class="usernameBadge">—</div>
        </div>
    </div>

    <div class="mainCard">
        <div class="chatWindow w-100">
            <div class="messages" id="messages"></div>

            <div class="controls">
                <div style="min-width:220px; max-width:320px;">
                    <input id="senderInput" type="text" placeholder="Enter your display name" value="" />
                    <div class="small-muted mt-1">Set your name and it will be shown to others.</div>
                </div>

                <div class="inputWrap">
                    <input id="messageInput" type="text" placeholder="Type your message and press Enter or Send" />
                    <button id="sendMessage" class="btn btn-primary">Send</button>
                </div>
            </div>
        </div>
    </div>

    <div class="small-muted text-center mt-2">Built with Spring Boot • WebSockets • STOMP</div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<!-- Use the stomp lib that exposes Stomp (your working one) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.1/stomp.min.js"></script>

<script>
    // --- Config: keep endpoint same as server ("/chat") and app dest
    const WS_ENDPOINT = '/chat';
    const APP_DEST = '/app/sendMessage';
    const TOPIC = '/topic/messages';

    // escape to avoid HTML injection
    function escapeHtml(s){
      if(!s && s!==0) return '';
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    // stomp client (using older over() because that's what you had working)
    let stompClient = null;
    function connect(){
      const socket = new SockJS(WS_ENDPOINT);
      stompClient = Stomp.over(socket);
      stompClient.connect({}, function(frame){
        console.log('Connected', frame);
        setConnected(true);
        stompClient.subscribe(TOPIC, function(message){
          try {
            const payload = JSON.parse(message.body);
            renderMessage(payload);
          } catch(e){
            console.error('Invalid message payload', message.body, e);
          }
        });
      }, function(err){
        console.error('STOMP error', err);
      });
    }

    function setConnected(connected){
      document.getElementById('sendMessage').disabled = !connected;
    }

    // read & cache username, update top-right display
    let myName = null;
    function updateUsername(){
      const v = (document.getElementById('senderInput').value || '').trim();
      myName = v || null;
      document.getElementById('usernameDisplay').textContent = myName ? escapeHtml(myName) : '—';
    }

    // send message
    function sendMessage(){
      if(!stompClient) return alert('Not connected yet');
      updateUsername();
      const content = document.getElementById('messageInput').value || '';
      if(!content.trim()) return;
      const payload = { sender: myName || 'anon', content: content.trim() };
      // publish to server
      stompClient.send(APP_DEST, {}, JSON.stringify(payload));
      // clear input (we rely on server echo to show message)
      document.getElementById('messageInput').value = '';
    }

    // render a message
    function renderMessage(m){
      const msgs = document.getElementById('messages');
      const wrapper = document.createElement('div');
      wrapper.className = 'msg ' + ((m.sender && myName && m.sender.toLowerCase() === myName.toLowerCase()) ? 'me' : 'other');

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = (m.sender && myName && m.sender.toLowerCase() === myName?.toLowerCase()) ? 'You' : (m.sender || 'anon');
      wrapper.appendChild(meta);

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = escapeHtml(m.content || '');
      wrapper.appendChild(bubble);

      msgs.appendChild(wrapper);
      msgs.scrollTop = msgs.scrollHeight - msgs.clientHeight + 200;
    }

    // init
    document.getElementById('sendMessage').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keydown', function(e){
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        sendMessage();
      }
    });
    document.getElementById('senderInput').addEventListener('input', updateUsername);
    window.addEventListener('load', () => {
      connect();
      updateUsername();
    });
</script>
</body>
</html>
