<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>RealTime Chat — Sexy UI</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root{
          --accent:#2563eb;
          --muted:#555;
          --bg:#ffffff;
          --card:#f2f2f2;
          --me-bg:#dbeafe;
          --other-bg:#e5e7eb;
        }

        html,body{height:100%;}

        body{
          font-family: "Inter", system-ui;
          background: var(--bg);
          color:#000;
          margin:0;
          padding:24px;
        }

        .app {
          max-width: 980px;
          margin: 0 auto;
          display:flex;
          flex-direction:column;
          gap:16px;
          color:#000;
        }

        .topbar {
          display:flex;
          align-items:center;
          justify-content:space-between;
          gap:12px;
          color:#000;
        }

        .brand { display:flex; gap:12px; align-items:center; }

        .logo {
          width:48px; height:48px; border-radius:10px;
          background:linear-gradient(135deg,#2563eb,#60a5fa);
          display:flex; align-items:center; justify-content:center;
          color:#fff; font-weight:700; font-size:18px;
        }

        .title { font-weight:700; font-size:18px; color:#000; }
        .subtitle { font-size:12px; color:#444; }

        .usernameBadge {
          background: #e5e7eb;
          padding:8px 12px; border-radius:999px;
          font-weight:600; font-size:14px;
          color:#000;
        }

        .mainCard{
          background: var(--card);
          border-radius:14px; padding:18px;
          display:flex; gap:16px; min-height:520px;
          color:#000;
          flex-direction:column; /* keep chat stacked for easier mobile handling */
        }

        .chatWindow{
          display:flex;
          flex-direction:column;
          gap:12px;
          width:100%;
        }

        /* NAME container placed at top of chatWindow */
        #nameContainer {
          display:flex;
          gap:8px;
          align-items:center;
          justify-content:space-between;
          min-width:0;
        }
        #nameContainer .left {
          display:flex;
          gap:8px;
          align-items:center;
          flex:1 1 auto;
          min-width:0;
        }
        #nameContainer input {
          flex:1 1 auto;
          min-width:0;
          padding:10px 12px;
          border-radius:10px;
          border:1px solid #ccc;
          background:#fff;
          color:#000;
          font-size:15px;
        }
        #nameContainer button {
          white-space:nowrap;
          padding:8px 12px;
          border-radius:10px;
          border:0;
          background:var(--accent);
          color:#fff;
          font-weight:600;
        }
        #nameContainer .hint {
          margin-left:12px;
          color:var(--muted);
          font-size:13px;
          flex:0 0 auto;
        }

        .messages {
          background: #fafafa;
          border-radius:12px; padding:18px;
          height:420px; overflow:auto;
          color:#000;
          border:1px solid #ddd;
        }

        .msg {
          display:flex;
          flex-direction:column;
          max-width:80%;
          margin-bottom:12px;
        }

        .meta {
          font-size:12px;
          color:#444;
          margin-bottom:4px;
        }

        .bubble {
          padding:12px 16px;
          border-radius:12px;
          font-size:15px;
          line-height:1.4;
          color:#000;
          border:1px solid #ddd;
          word-wrap:break-word;
          white-space:pre-wrap;
        }

        .me { align-self:flex-end; text-align:right; }
        .me .bubble {
          background: var(--me-bg);
          border-color:#93c5fd;
        }

        .other .bubble {
          background: var(--other-bg);
          border-color:#ccc;
        }

        .controls {
          display:flex; gap:12px;
          align-items:center;
          margin-top:8px;
        }

        .inputWrap {
          display:flex; gap:8px;
          align-items:center;
          width:100%;
        }

        .inputWrap input {
          padding:12px 14px;
          border-radius:10px;
          background: #fff;
          border:1px solid #ccc;
          outline:none; width:100%;
          color:#000;
          font-size:15px;
        }

        .btn-primary {
          background: var(--accent);
          border:0; padding:10px 16px; border-radius:10px;
          color:white; font-weight:600;
        }

        .small-muted { color:#555; font-size:13px; }

        /* MOBILE / RESPONSIVE adjustments */
        @media (max-width:720px){
          body { padding:12px; }
          .mainCard { padding:12px; min-height:480px; }
          .messages{ height:320px; padding:14px; }
          .controls{ flex-direction:column; align-items:stretch; }
          .inputWrap{ width:100%; }
          #nameContainer {
            flex-direction:column;
            align-items:stretch;
            gap:8px;
          }
          #nameContainer .left { flex-direction:row; }
          #nameContainer .hint { margin-left:0; color:#666; }
        }
    </style>

</head>
<body>
<div class="app container">
    <div class="topbar">
        <div class="brand">
            <div class="logo">RT</div>
            <div>
                <div class="title">RealTime Chat</div>
                <div class="subtitle">Talk-to-Stranger • Real-time • Lightweight</div>
            </div>
        </div>

        <div>
            <span style="font-size:13px; color:var(--muted);">Signed in as</span>
            <span id="usernameDisplay" class="usernameBadge">—</span>
        </div>
    </div>

    <div class="mainCard">
        <div class="chatWindow w-100">
            <!-- moved: username input sits above messages -->
            <div id="nameContainer" aria-live="polite">
                <div class="left">
                    <input id="senderInput" type="text" placeholder="Enter your display name" aria-label="Display name" />
                    <button id="setNameBtn" class="btn btn-primary btn-sm">Set</button>
                </div>
                <div class="hint small-muted">Set your name (press Enter or tap Set)</div>
            </div>

            <div class="messages" id="messages" role="log" aria-live="polite"></div>

            <div class="controls">
                <div class="inputWrap">
                    <input id="messageInput" type="text" placeholder="Type your message…" aria-label="Message" />
                    <button id="sendMessage" class="btn btn-primary" disabled>Send</button>
                </div>
            </div>
        </div>
    </div>

    <div class="small-muted text-center mt-2">Built with Spring Boot • WebSockets • STOMP</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.1/stomp.min.js"></script>

<script>
    const WS_ENDPOINT = '/chat';
    const APP_DEST = '/app/sendMessage';
    const TOPIC = '/topic/messages';

    function escapeHtml(s){
      return String(s||"")
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    let stompClient = null;
    function connect(){
      const socket = new SockJS(WS_ENDPOINT);
      stompClient = Stomp.over(socket);
      stompClient.connect({}, frame => {
        document.getElementById('sendMessage').disabled = false;
        stompClient.subscribe(TOPIC, message => {
          try {
            renderMessage(JSON.parse(message.body));
          } catch(e){
            console.error('invalid message', e);
          }
        });
      }, err => {
        console.error('stomp connect err', err);
      });
    }

    let myName = null;
    const nameContainer = document.getElementById('nameContainer');
    const senderInput = document.getElementById('senderInput');
    const setNameBtn = document.getElementById('setNameBtn');

    function updateUsernameDisplay(name){
      document.getElementById('usernameDisplay').textContent = name ? escapeHtml(name) : '—';
    }

    function previewUsername(){
      const v = senderInput.value;
      updateUsernameDisplay(v ? v.trim() : null);
    }

    function confirmUsername(){
      const v = senderInput.value.trim();
      if(!v){ alert("Name cannot be empty."); senderInput.focus(); return; }
      myName = v;
      updateUsernameDisplay(myName);
      // hide/lock the input area so user can't edit unless refresh
      nameContainer.style.display = 'none';
      document.getElementById('messageInput').focus();
    }

    senderInput.addEventListener('input', previewUsername);
    senderInput.addEventListener('keydown', e => {
      if(e.key === 'Enter'){
        e.preventDefault();
        confirmUsername();
      }
    });
    setNameBtn.addEventListener('click', confirmUsername);

    function sendMessage(){
      if(!myName){
        alert("Set your display name first.");
        return;
      }
      const txt = document.getElementById('messageInput').value.trim();
      if(!txt) return;
      stompClient.send(APP_DEST, {}, JSON.stringify({ sender: myName, content: txt }));
      document.getElementById('messageInput').value = "";
    }

    document.getElementById('sendMessage').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keydown', e => {
      if(e.key === 'Enter'){
        e.preventDefault();
        sendMessage();
      }
    });

    function renderMessage(m){
      const msgs = document.getElementById('messages');
      const wrap = document.createElement('div');
      const isMe = myName && m.sender?.toLowerCase() === myName.toLowerCase();

      wrap.className = "msg " + (isMe ? "me" : "other");

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = isMe ? "You" : (m.sender || 'anon');
      wrap.appendChild(meta);

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = escapeHtml(m.content || '');
      wrap.appendChild(bubble);

      msgs.appendChild(wrap);
      // keep newest visible
      msgs.scrollTop = msgs.scrollHeight;
    }

    window.addEventListener('load', () => {
      connect();
      updateUsernameDisplay(null);
    });
</script>
</body>
</html>
